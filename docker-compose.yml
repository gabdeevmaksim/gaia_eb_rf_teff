services:
  # Training service - Full environment for model training
  train:
    build:
      context: .
      dockerfile: Dockerfile.train
    image: gaia-eb-teff:train
    container_name: gaia-eb-train
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./reports:/app/reports
      - ./config:/app/config
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - KAGGLE_USERNAME=${KAGGLE_USERNAME}
      - KAGGLE_KEY=${KAGGLE_KEY}
    # Default: train gaia_teff_corrected_log model
    # Override with: docker-compose run train --ml --ml-config config/models/your_model.yaml
    command: --ml --ml-config config/models/gaia_teff_corrected_log.yaml

  # Prediction service - Lightweight for inference
  predict:
    build:
      context: .
      dockerfile: Dockerfile
    image: gaia-eb-teff:predict
    container_name: gaia-eb-predict
    volumes:
      - ./data:/app/data:ro     # Read-only
      - ./models:/app/models:ro  # Read-only
      - ./predictions:/app/predictions
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - MODEL_NAME=${MODEL_NAME:-rf_gaia_teff_corrected_log_20251126_130144}
    # Default: predict using gaia colors
    command: --predict --pred-config config/prediction/predict_gaia_colors_teff.yaml

  # Validation service - Generate validation plots
  validate:
    build:
      context: .
      dockerfile: Dockerfile.train  # Needs matplotlib for plots
    image: gaia-eb-teff:validate
    container_name: gaia-eb-validate
    volumes:
      - ./models:/app/models:ro
      - ./reports:/app/reports
    # Default: validate latest trained model
    command: --validate --val-config config/validation/validate_latest_model.yaml

  # Data processing service
  data:
    build:
      context: .
      dockerfile: Dockerfile.train
    image: gaia-eb-teff:data
    container_name: gaia-eb-data
    volumes:
      - ./data:/app/data
    environment:
      - HF_TOKEN=${HF_TOKEN}
    command: --data

# Optional: Named volumes for persistent data
# volumes:
#   gaia_data:
#   gaia_models:
#   gaia_reports:
